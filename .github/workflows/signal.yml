name: Update signals + spreads and deploy

on:
  schedule:
    - cron: "30 * * * *"
  workflow_dispatch:

permissions:
  contents: write   # IMPORTANT: needed to push updated JSON back to repo
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install yfinance finnhub-python pandas ta numpy textblob newspaper3k lxml_html_clean transformers torch huggingface_hub

      - name: Run Signal.py
        run: python Signal.py
        env:
          API_KEY: ${{ secrets.API_KEY }}

      - name: Verify outputs exist
        run: |
          ls -la data || true
          test -f data/signals.json || (echo "Missing data/signals.json" && exit 1)
          test -f data/spreads.json || (echo "Missing data/spreads.json" && exit 1)
          echo "signals.json bytes: $(wc -c < data/signals.json)"
          echo "spreads.json bytes: $(wc -c < data/spreads.json)"

      # ---------------------------
      # âœ… Commit BOTH json files
      # ---------------------------
      - name: Commit updated JSON to repo
        run: |
          git config user.name "actions-user"
          git config user.email "actions-user@users.noreply.github.com"

          git add data/signals.json data/spreads.json

          # If no changes, don't fail
          git commit -m "Update signals.json and spreads.json from workflow" || echo "No changes to commit"
          git push

      # ---------------------------
      # Build pages artifact (must include data/)
      # ---------------------------
      - name: Build Pages bundle
        run: |
          rm -rf artifacts
          mkdir -p artifacts
          mkdir -p artifacts/data

          # Copy your static site files (adjust if needed)
          # If your index.html is under pages/, change this accordingly.
          if [ -f index.html ]; then
            cp -r index.html scripts styles assets pages artifacts/ 2>/dev/null || true
          else
            # If your real HTML lives under pages/
            cp -r pages artifacts/ 2>/dev/null || true
            cp -r scripts styles assets artifacts/ 2>/dev/null || true
          fi

          # Force updated JSON into published /data/
          cp -f data/signals.json artifacts/data/signals.json
          cp -f data/spreads.json artifacts/data/spreads.json

          echo "Artifacts data folder:"
          ls -la artifacts/data

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: artifacts

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
